<html>
<!-- Head tag -->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>Kasei's Blog</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link rel="stylesheet" href="/css/ie10-viewport-bug-workaround.css">
    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="/css/blog.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


    <script src="https://use.typekit.net/xdq4yde.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
    
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<!-- get screen size -->


  <body>
      <div id="mobile-hidden-panel" class="collapse">
        <div class="hidden-pannel-wrapper">
            <div class="sidebar-module sidebar-widgets">
  
    
    
    <div class="widget-wrapper about-widget">

        <div class="widget-container">
          <div class="flex-item-wrapper">
            <div class="profile-wrapper">
              <div class="profile-image">
                <img src = '/images/profile.png' alt = "profile picture">
              </div>
            </div>
          </div>
          <div class="flex-item-wrapper">
            <p class="description">我が名はカセイ</p>
            <hr>
           <div class="location-wrapper">
             <p class="location"><span class="glyphicon glyphicon-map-marker"></span> Singapore</p>
           </div>
           <hr>
           <div class="social-wrapper">
             
             <a href="https://github.com/huashengwang1989/" target="_blank">
              <svg class="glyphicon glyphicon-ant-github" alt="GitHub Icon" ><use xlink:href="/icon/ant-github.svg#si-ant-github"></use></svg>
            </a>
            
           </div>
         </div>
       </div>

    </div>

  
    
    
    <div class="widget-wrapper menu-widget">

        <div class="widget-container">
          <div class="menu-wrapper">
            <nav class="nav">
                
                    <div class="nav-item">
                      <a href="/">Home</a>
                    </div>
                
                    <div class="nav-item">
                      <a href="/archives">Archives</a>
                    </div>
                
            </nav>
          </div>
         </div>
    </div>

  
    
    

  
</div>

        </div>
      </div>
      <div id="wrapper">
        <div id="mobile-header-wrapper">
          <nav class="header-nav">
  
    <div class="widget-wrapper menu-widget">

        <div class="widget-container">
          <div class="menu-wrapper">
            <nav class="nav">
                
                    <div class="nav-item">
                      <a href="/">Home</a>
                    </div>
                
                    <div class="nav-item">
                      <a href="/archives">Archives</a>
                    </div>
                
            </nav>
          </div>
         </div>
    </div>

  <div class="nav-profile-wrapper">
    <div class="nav-profile-image">
      <a class="nav-profile-toggle-button" data-toggle="collapse" data-target="#mobile-hidden-panel">
        <img src = '/images/profile.png' alt = "profile picture">
      </a>
    </div>
  </div>
</nav>

        </div>
        <div id="container">

            <!-- Sidebar -->

          <div id="sidebar-wrapper">
              <div class="sidebar-module sidebar-widgets">
  
    
    
    <div class="widget-wrapper about-widget">

        <div class="widget-container">
          <div class="flex-item-wrapper">
            <div class="profile-wrapper">
              <div class="profile-image">
                <img src = '/images/profile.png' alt = "profile picture">
              </div>
            </div>
          </div>
          <div class="flex-item-wrapper">
            <p class="description">我が名はカセイ</p>
            <hr>
           <div class="location-wrapper">
             <p class="location"><span class="glyphicon glyphicon-map-marker"></span> Singapore</p>
           </div>
           <hr>
           <div class="social-wrapper">
             
             <a href="https://github.com/huashengwang1989/" target="_blank">
              <svg class="glyphicon glyphicon-ant-github" alt="GitHub Icon" ><use xlink:href="/icon/ant-github.svg#si-ant-github"></use></svg>
            </a>
            
           </div>
         </div>
       </div>

    </div>

  
    
    
    <div class="widget-wrapper menu-widget">

        <div class="widget-container">
          <div class="menu-wrapper">
            <nav class="nav">
                
                    <div class="nav-item">
                      <a href="/">Home</a>
                    </div>
                
                    <div class="nav-item">
                      <a href="/archives">Archives</a>
                    </div>
                
            </nav>
          </div>
         </div>
    </div>

  
    
    

  
</div>

          </div>


          <div id="page-container-wrapper">

            <div id="page-container">
                <!-- Blog Header: title and subtitle -->
                <div id="header-wrapper">
                  <div class="blog-header">
    <h1 class="blog-title">
      <a href="/">カセイちゃんの動物園</a>
    </h1>
    <p class="lead blog-description">A random blog to record tech ideas</p>
</div>

                </div>

                <!-- Main Content -->
                <div id="page-content-wrapper">
                  <div class="page-content">
                      <div class="row">
                          <div class="blog-entry">
                              <div class="blog-post full-article">
    <!-- Title -->
    <div class="blog-header">
      <h2 class="blog-post-title">
            Styles Consolidation Among iView Less, Scss in Vue Templates and JavaScript
      </h2>
      <!-- Date and Author -->
      <div class="blog-post-meta">
          <span class="blog-date">2018-09-06</span>
          
      </div>
      <!-- Tags and Categories links -->
      <div class="blog-post-additional">
        <span class="blog-tags">

<div class="blog-tags-container">
    <span class="glyphicon glyphicon-tags"></span>
    <a href="/tags/iview/">iView</a> <a href="/tags/less/">less</a> <a href="/tags/sass/">sass</a> <a href="/tags/stylesheets/">stylesheets</a>
</div>

</span>
        <span class="blog-cats">
</span>
      </div>
    </div>

    <!-- Content -->
    <div class="blog-content-wrapper">
        <div class="blog-content">
        <h3 id="0x00-SCSS-Variables"><a href="#0x00-SCSS-Variables" class="headerlink" title="0x00: SCSS Variables"></a>0x00: SCSS Variables</h3><p>In a Vue template file, say <code>sample.vue</code>, I can define variables in the <code>scss</code> styles. In this way, I can reuse it across the <code>scss</code> in this template file:</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- my virtual DOMs --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>scss<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token style language-css">
    <span class="token selector">$my-color: <span class="token id">#fcfcfc</span>;
    <span class="token class">.my-class</span></span><span class="token punctuation">{</span>
        <span class="token property">color</span><span class="token punctuation">:</span> $my-color<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span>
    // my JavaScript
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<a id="more"></a>
<p>If I want to have some style variables shared across all my template files, I can create an <code>scss</code> file, say <code>common.styles.scss</code>, and put it somewhere. Then at the style section in every template file, I can <code>@import</code> this file so that the variables there are usable.</p>
<p>A sample <code>common.styles.scss</code>:</p>
<pre class="line-numbers language-scss"><code class="language-scss"><span class="token property"><span class="token variable">$my-color-a</span></span><span class="token punctuation">:</span> <span class="token hexcode">#fcfcfc</span><span class="token punctuation">;</span>
<span class="token property"><span class="token variable">$my-color-b</span></span><span class="token punctuation">:</span> <span class="token hexcode">#f8f8f9</span><span class="token punctuation">;</span>
<span class="token property"><span class="token variable">$my-color-c</span></span><span class="token punctuation">:</span> <span class="token hexcode">#ffffff</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="0x01-Global-SCSS-Variables-to-Vue-Template-Styles"><a href="#0x01-Global-SCSS-Variables-to-Vue-Template-Styles" class="headerlink" title="0x01: Global SCSS Variables to Vue Template Styles"></a>0x01: Global SCSS Variables to Vue Template Styles</h3><p>This sounds good, but has one big problem: I have already had almost 100 Vue template files. It is quite silly that I have to write the same line for existing and any future <code>.vue</code> files.</p>
<p>Yes, there is an existing webpack loader that does exactly the job: <a href="https://github.com/shakacode/sass-resources-loader" target="_blank" rel="noopener"><code>sass-resources-loader</code></a> (webpack 4 OK!). You may install it via <code>npm</code>:</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">npm</span> i sass-resources-loader --save-dev
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>and then in your webpack config file (<em>e.g.</em> <code>webpack.config.js</code>):</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> style_loaders <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'css'</span><span class="token punctuation">:</span> <span class="token string">'vue-style-loader!css-loader'</span><span class="token punctuation">,</span>
    <span class="token string">'scss'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">'vue-style-loader'</span><span class="token punctuation">,</span>
        <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
        <span class="token string">'sass-loader'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span> <span class="token string">'sass-resources-loader'</span><span class="token punctuation">,</span>
            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                resources<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'my-path-to-styles/common.styles.scss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>


module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/.vue$/</span><span class="token punctuation">,</span>
                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token punctuation">{</span>
                        loader<span class="token punctuation">:</span> <span class="token string">'vue-loader'</span><span class="token punctuation">,</span>
                        options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                            extractCSS<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                            loaders<span class="token punctuation">:</span> style_loaders
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                test<span class="token punctuation">:</span> <span class="token regex">/\.scss$/</span><span class="token punctuation">,</span>
                use<span class="token punctuation">:</span> <span class="token punctuation">[</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>style_loaders<span class="token punctuation">.</span>scss<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> 
                <span class="token comment" spellcheck="true">// other rules...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// ... </span>
<span class="token punctuation">}</span>


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>sass-resources-loader</code> will directly take whatever text inside the specified <code>scss</code> file (<code>common.styles.scss</code> here) to the top of all the <code>&lt;style lang=&quot;scss&quot;&gt;&lt;/style&gt;</code>, even non-scss scripts or random texts. In this way, if you have done the <code>scss</code> file properly, you will be able to use this global <code>scss</code> style variables across Vue template file. If you have any “illegal” contents in your <code>scss</code> file, it would be other loader’s job to throw an <code>Error</code>.</p>
<h3 id="0x02-I-Want-Them-in-LESS-and-JS-Too"><a href="#0x02-I-Want-Them-in-LESS-and-JS-Too" class="headerlink" title="0x02: I Want Them in LESS and JS Too"></a>0x02: I Want Them in LESS and JS Too</h3><p>However, the above <code>sccs</code> globals cannot be accessed by the JavaScript:  </p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token operator">&lt;</span>template<span class="token operator">></span>
    <span class="token operator">&lt;</span>my<span class="token operator">-</span>component <span class="token punctuation">:</span>style<span class="token operator">=</span><span class="token string">"myInlineStyle"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>my<span class="token operator">-</span>component<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">></span>
<span class="token operator">&lt;</span>script<span class="token operator">></span>
    <span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//...</span>
        computed<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            myInlineStyle<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                     <span class="token string">'backgroundColor'</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">?</span> <span class="token comment" spellcheck="true">// I want to access to the global style variables here too</span>
                <span class="token punctuation">}</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>After searching, I found another webpack loader that seemed to do the job: <a href="https://www.npmjs.com/package/node-sass-json-importer" target="_blank" rel="noopener"><code>node-sass-json-importer</code></a>. It can import <code>.json</code> or <code>.json5</code> to <code>scss</code> files via the <code>@import</code> syntax.</p>
<p><code>JSON</code> would be quite easy to be imported to JavaScript, <em>e.g.</em> store the values as a global object in <code>main.js</code>. However, writing <code>JSON</code> is troublesome; you may wish to have another level above, such as a <code>.js</code> file output to <code>.json</code>.</p>
<p>PS: by reading the source code, <code>node-sass-json-importer</code> seems possible to parse exported Javascript object; but it will have a check of the filetype at the beginning, and will not proceed if the file url at <code>@import</code> does not match <code>/.json5?$/</code>. This not only makes it impossible to import a <code>.js</code> file, also it will have problem for styles in vue template, which will be detailed in next part.</p>
<p>Meanwhile, if some other UI Frameworks are used such as <a href="https://www.iviewui.com" target="_blank" rel="noopener">iView</a>, they may use <code>less</code> for the styles. iView has supplied a list of <code>less</code> variables, which you may customize them to overwrite iView’s default styles. It would be best if there is something that can kill both with one stone.</p>
<p><a href="https://www.npmjs.com/package/js-to-styles-var-loader" target="_blank" rel="noopener"><code>js-to-styles-var-loader</code></a> seems to be able to do the job based on its name and docs. By first look, it have two good points:</p>
<ul>
<li>It can directly get the output values from JavaScript modules;</li>
<li>and it can add these values to both <code>less</code> and <code>sass</code>.</li>
</ul>
<p>With this loader, a line at the top of the <code>less</code> and ‘sass’ files will do: </p>
<pre><code>require(&#39;my-path-to/shared.styles.js&#39;)
</code></pre><p>However, it doesn’t work in real life.</p>
<p>Looking through the source code, I discovered that there are several places in the code causing the problem:</p>
<ul>
<li><p>This loader gets the file path by looking for the <code>require</code> line, parsing it with a <code>regex</code> to get the relative path, and using <code>path.join</code> to join this relative path to <code>webpackContext.context</code>. This means, <code>&#39;./&#39;</code>, <code>&#39;../&#39;</code> in the path would not work, unless you put the style files you wish to import the js module at the root folder. Moreover, the <code>regex</code> itself prevents symbols like <code>@</code>, which many may use it for webpack path alias.</p>
</li>
<li><p>This loader will also check the file extension. If it is not <code>.scss</code>, <code>.sass</code> or <code>.less</code>, an <code>Error</code> will throw. As <code>sass-resources-loader</code> will only blindly copy whatever in these style files to Vue template styles, the <code>require</code> line will also be copied to all Vue templates – unless you do the translation at its <code>options.resources</code> (too challenging…). Having <code>require</code> line in Vue templates means that first, it would be a <code>.vue?type=styles...</code> and would not pass the file type check; second, the relative path in the <code>require</code> line will not hold as now it is relative to each <code>.vue</code> file and they are in different nested folders.</p>
</li>
</ul>
<h3 id="0x03-Rewrite-the-Loader"><a href="#0x03-Rewrite-the-Loader" class="headerlink" title="0x03: Rewrite the Loader"></a>0x03: Rewrite the Loader</h3><ol>
<li>Change the <code>requireReg</code> to the following so that it can supports various path formats and the restriction on file types is lifted:</li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> requireReg <span class="token operator">=</span> <span class="token regex">/require\s*\((["'])([@\/]?[\w.\-\/]+)(?:\1)\)((?:\.[\w_-]+)*);?/igm</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>PS: I only updated it to my own needs. If you need support for <code>&#39;~&#39;</code> <em>etc.</em>, please update it by yourself.</p>
<ol start="2">
<li>Update the <code>getPreprocessorType</code> function with a param named <code>&#39;enforceType&#39;</code>. Previously the file type is checked here. Now if <code>&#39;enforceType&#39;</code> is specified, the check on the file extension will be skipped.</li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript">getPreprocessorType <span class="token punctuation">(</span> <span class="token punctuation">{</span> resource<span class="token punctuation">,</span> enforceType <span class="token punctuation">}</span> <span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'sass'</span><span class="token punctuation">,</span><span class="token string">'scss'</span><span class="token punctuation">,</span><span class="token string">'less'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>enforceType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> enforceType <span class="token operator">===</span> <span class="token string">'less'</span> <span class="token operator">?</span> <span class="token string">'less'</span> <span class="token punctuation">:</span> <span class="token string">'sass'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>Use <code>webpackContext.resolve</code> instead of <code>path.join</code> in <code>mergeVarsToContent</code> function. As <code>webpackContext.resolve</code> is async, <code>&#39;string-replace-async&#39;</code> is used in place of <code>String.prototype.replace</code>. You need <code>npm install</code> this module first. This function will then need return a <code>Promise</code> instead.</li>
</ol>
<p><strong>Update</strong>: Found that <code>webpackContext.resolve</code> is not able to handle the case when <code>relativePath</code> is only the filename. It will have the error in the callback. In this case, I will simply use the original <code>path.join</code> to handle <code>modulePath</code>.</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save string-replace-async
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>And here’s the code part:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> stringReplaceAsync <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'string-replace-async'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//...</span>
<span class="token keyword">const</span> operator <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ...</span>
    mergeVarsToContent <span class="token punctuation">(</span>content<span class="token punctuation">,</span> webpackContext<span class="token punctuation">,</span> preprocessorType<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> replacer <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>match_require_string<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">function</span> <span class="token function">handlePathResolve</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> modulePath<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// If only the file name, webpackContext.resolve would throw an error.</span>
                        <span class="token comment" spellcheck="true">// in this case, just join the path as the original.</span>
                        modulePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>webpackContext<span class="token punctuation">.</span>context<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">const</span> varData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getVarData</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">propDeDot</span><span class="token punctuation">(</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    webpackContext<span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>modulePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> style_vars <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transformToStyleVars</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        type<span class="token punctuation">:</span> preprocessorType<span class="token punctuation">,</span>
                        varData
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>style_vars<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                webpackContext<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>webpackContext<span class="token punctuation">.</span>context<span class="token punctuation">,</span> relativePath<span class="token punctuation">,</span> handlePathResolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">stringReplaceAsync</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> requireReg<span class="token punctuation">,</span> replacer<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// ...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>Tell webpack that this is an async loader. Allow it to pass the processor you wish to use via the options with <code>options.useProcessor</code>, which will become the <code>&#39;enforceType&#39;</code> for <code>operator.getPreprocessorType</code> function.</li>
</ol>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">const</span> loader <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> webpackContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> resource <span class="token operator">=</span> operator<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>webpackContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> loaderUtils<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span>webpackContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> enforce_preprocessor_type <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>useProcessor <span class="token operator">?</span> options<span class="token punctuation">.</span>useProcessor <span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> preprocessorType <span class="token operator">=</span> operator<span class="token punctuation">.</span><span class="token function">getPreprocessorType</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
        resource<span class="token punctuation">,</span> 
        <span class="token string">'enforceType'</span><span class="token punctuation">:</span> enforce_preprocessor_type 
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> callback <span class="token operator">=</span> webpackContext<span class="token punctuation">.</span><span class="token keyword">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Async loader</span>
    operator<span class="token punctuation">.</span><span class="token function">mergeVarsToContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> webpackContext<span class="token punctuation">,</span> preprocessorType<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token keyword">default</span> <span class="token operator">=</span> loader<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>I’ve forked <code>js-to-styles-var-loader</code> and included these updates temporarily in the <a href="https://github.com/huashengwang1989/js-to-styles-var-loader/tree/dev" target="_blank" rel="noopener">dev branch</a> in my channel. You may find the <code>index.js</code> file there. Nonetheless I have not tested yet, nor the test scripts and demos are updated. So use it at your own risk.</p>
<h3 id="0x04-Use-Custom-Loader-in-Webpack"><a href="#0x04-Use-Custom-Loader-in-Webpack" class="headerlink" title="0x04: Use Custom Loader in Webpack"></a>0x04: Use Custom Loader in Webpack</h3><p>Webpack can add custom loader. You may add the following line: </p>
<pre class="line-numbers language-javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode<span class="token punctuation">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// or 'production'</span>
    <span class="token comment" spellcheck="true">// ...</span>
    resolveLoader<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        alias<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'my-custom-loader'</span><span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'path-to-loader/my-custom-loader.js'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Then you may use this loader in the same way as other loaders:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token punctuation">{</span>
    loader<span class="token punctuation">:</span> <span class="token string">'my-custom-loader'</span><span class="token punctuation">,</span>    
    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        useProcessor<span class="token punctuation">:</span> <span class="token string">'scss'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>If <code>sass-resources-loader</code> is used, this should be put above <code>sass-resources-loader</code>, as loaders are loaded from the last to the first. For the <code>style_loaders</code> mentioned before, now becomes:</p>
<pre class="line-numbers language-javascript"><code class="language-javascript"><span class="token keyword">var</span> style_loaders <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'css'</span><span class="token punctuation">:</span> <span class="token string">'vue-style-loader!css-loader'</span><span class="token punctuation">,</span>
    <span class="token string">'scss'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">'vue-style-loader'</span><span class="token punctuation">,</span>
        <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
        <span class="token string">'sass-loader'</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span> <span class="token string">'my-custom-loader'</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// put here!</span>
            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                useProcessor<span class="token punctuation">:</span> <span class="token string">'scss'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            loader<span class="token punctuation">:</span> <span class="token string">'sass-resources-loader'</span><span class="token punctuation">,</span>
            options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                resources<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'my-path-to-styles/common.styles.scss'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Hope this post helps.</p>

      </div>
    </div>

</div>


                          </div>
                       </div>
                    </div>
                </div>

              </div>

              <!-- Footer -->
              <footer class="blog-footer">
    <p>2017 &copy; Kasei. Template built based on <a href="http://getbootstrap.com">Bootstrap</a>.</p>
</footer>

              <!-- After footer scripts -->
              <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/js/ie10-viewport-bug-workaround.js"></script>



            </div>
          </div>

      </div>

  </body>

</html>
