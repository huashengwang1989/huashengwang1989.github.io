<html>
<!-- Head tag -->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="apple-touch-icon" sizes="57x57" href="/favicon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/favicon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/favicon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/favicon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/favicon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/favicon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/favicon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/favicon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/favicon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <title>Kasei's Blog</title>
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link rel="stylesheet" href="/css/ie10-viewport-bug-workaround.css">
    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="/css/blog.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->


    <script src="https://use.typekit.net/xdq4yde.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>
    
<link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<!-- get screen size -->


  <body>
      <div id="mobile-hidden-panel" class="collapse">
        <div class="hidden-pannel-wrapper">
            <div class="sidebar-module sidebar-widgets">
  
    
    
    <div class="widget-wrapper about-widget">

        <div class="widget-container">
          <div class="flex-item-wrapper">
            <div class="profile-wrapper">
              <div class="profile-image">
                <img src = '/images/profile.png' alt = "profile picture">
              </div>
            </div>
          </div>
          <div class="flex-item-wrapper">
            <p class="description">我が名はカセイ</p>
            <hr>
           <div class="location-wrapper">
             <p class="location"><span class="glyphicon glyphicon-map-marker"></span> Singapore</p>
           </div>
           <hr>
           <div class="social-wrapper">
             
             <a href="https://github.com/huashengwang1989/" target="_blank">
              <svg class="glyphicon glyphicon-ant-github" alt="GitHub Icon" ><use xlink:href="/icon/ant-github.svg#si-ant-github"></use></svg>
            </a>
            
           </div>
         </div>
       </div>

    </div>

  
    
    
    <div class="widget-wrapper menu-widget">

        <div class="widget-container">
          <div class="menu-wrapper">
            <nav class="nav">
                
                    <div class="nav-item">
                      <a href="/">Home</a>
                    </div>
                
                    <div class="nav-item">
                      <a href="/archives">Archives</a>
                    </div>
                
            </nav>
          </div>
         </div>
    </div>

  
    
    

  
</div>

        </div>
      </div>
      <div id="wrapper">
        <div id="mobile-header-wrapper">
          <nav class="header-nav">
  
    <div class="widget-wrapper menu-widget">

        <div class="widget-container">
          <div class="menu-wrapper">
            <nav class="nav">
                
                    <div class="nav-item">
                      <a href="/">Home</a>
                    </div>
                
                    <div class="nav-item">
                      <a href="/archives">Archives</a>
                    </div>
                
            </nav>
          </div>
         </div>
    </div>

  <div class="nav-profile-wrapper">
    <div class="nav-profile-image">
      <a class="nav-profile-toggle-button" data-toggle="collapse" data-target="#mobile-hidden-panel">
        <img src = '/images/profile.png' alt = "profile picture">
      </a>
    </div>
  </div>
</nav>

        </div>
        <div id="container">

            <!-- Sidebar -->

          <div id="sidebar-wrapper">
              <div class="sidebar-module sidebar-widgets">
  
    
    
    <div class="widget-wrapper about-widget">

        <div class="widget-container">
          <div class="flex-item-wrapper">
            <div class="profile-wrapper">
              <div class="profile-image">
                <img src = '/images/profile.png' alt = "profile picture">
              </div>
            </div>
          </div>
          <div class="flex-item-wrapper">
            <p class="description">我が名はカセイ</p>
            <hr>
           <div class="location-wrapper">
             <p class="location"><span class="glyphicon glyphicon-map-marker"></span> Singapore</p>
           </div>
           <hr>
           <div class="social-wrapper">
             
             <a href="https://github.com/huashengwang1989/" target="_blank">
              <svg class="glyphicon glyphicon-ant-github" alt="GitHub Icon" ><use xlink:href="/icon/ant-github.svg#si-ant-github"></use></svg>
            </a>
            
           </div>
         </div>
       </div>

    </div>

  
    
    
    <div class="widget-wrapper menu-widget">

        <div class="widget-container">
          <div class="menu-wrapper">
            <nav class="nav">
                
                    <div class="nav-item">
                      <a href="/">Home</a>
                    </div>
                
                    <div class="nav-item">
                      <a href="/archives">Archives</a>
                    </div>
                
            </nav>
          </div>
         </div>
    </div>

  
    
    

  
</div>

          </div>


          <div id="page-container-wrapper">

            <div id="page-container">
                <!-- Blog Header: title and subtitle -->
                <div id="header-wrapper">
                  <div class="blog-header">
    <h1 class="blog-title">
      <a href="/">カセイちゃんの動物園</a>
    </h1>
    <p class="lead blog-description">A random blog to record tech ideas</p>
</div>

                </div>

                <!-- Main Content -->
                <div id="page-content-wrapper">
                  <div class="page-content">
                      <div class="row">
                          <div class="blog-entry">
                              <div class="blog-post full-article">
    <!-- Title -->
    <div class="blog-header">
      <h2 class="blog-post-title">
            Debugging Mocha Setup for Vue Project
      </h2>
      <!-- Date and Author -->
      <div class="blog-post-meta">
          <span class="blog-date">2018-09-08</span>
          
      </div>
      <!-- Tags and Categories links -->
      <div class="blog-post-additional">
        <span class="blog-tags">
</span>
        <span class="blog-cats">
</span>
      </div>
    </div>

    <!-- Content -->
    <div class="blog-content-wrapper">
        <div class="blog-content">
        <p>I am working on a Vue project with Webpack 4 and Babel 7.</p>
<p>At the point of writing this post, it is Webpack 4.12.0 and Babel 7.0.0-rc.1.</p>
<p>When setting up Mocha with <code>@vue/test-util</code>, I have encountered a number of bugs.</p>
<p>After a number of rounds try, my test script in <code>package.json</code> becomes:</p>
<pre><code>&quot;scripts&quot;: {
    &quot;test&quot;: &quot;cross-env NODE_ENV=test nyc mocha-webpack --full-trace --recursive --require @babel/register --require ignore-styles --require test/setup.js test/**/*.spec.js&quot;
}
</code></pre><p>Is it necessary or overkill? Will all the additional flags be the solution to problems, or the cause of new errors?</p>
<p>Probably yes.</p>
<a id="more"></a>
<h3 id="Debug-1-Filename"><a href="#Debug-1-Filename" class="headerlink" title="Debug 1: Filename"></a>Debug 1: Filename</h3><pre><code>Cannot find module &#39;my-path/main.[hash].js?[hash]&#39;
    at Function.Module._resolveFilename (module.js)
</code></pre><p>This is because of the hash after the output filename. Check <code>webpack.config.js</code> config <code>output.filename</code>. If the hash is within the filename, it works fine.</p>
<h3 id="Debug-2-Styles"><a href="#Debug-2-Styles" class="headerlink" title="Debug 2: Styles"></a>Debug 2: Styles</h3><pre><code>.my-class-name[data-v-hash] {
^

SyntaxError: Unexpected token .
    at createScript (vm.js)
</code></pre><p>Check whether you have extract CSS plugins <em>e.g.</em> <code>MiniCssExtractPlugin.loader</code> enabled for <code>test</code> environment. If yes, this may be the cause of the error.</p>
<p>Check <code>webpack.config.js</code> config <code>module.rules</code> for related settings.</p>
<p>For my project, I uses Vue templates with scss.</p>
<ul>
<li>For <code>vue-loader</code> (<code>test: /\.vue$/</code>), its <code>options.extractCSS</code> is always <code>true</code> and not causing the problem;</li>
<li>For <code>test: /\.css$/</code>, having <code>MiniCssExtractPlugin.loader</code> is not causing the problem;</li>
<li>For <code>test: /\.scss$/</code>, having <code>MiniCssExtractPlugin.loader</code> leads to the problem; (More related problems see below)</li>
<li>For <code>test: /\.less$/</code> which I only used a <code>less</code> file to overwrite iView’s default theme, having <code>MiniCssExtractPlugin.loader</code> is not causing the problem.</li>
</ul>
<h3 id="Debug-3-No-Error-but-No-Tests-1"><a href="#Debug-3-No-Error-but-No-Tests-1" class="headerlink" title="Debug 3: No Error but No Tests 1"></a>Debug 3: No Error but No Tests 1</h3><p>There are tests but “<code>0 passing (0ms)</code>“ and “<code>Tests completed successfully</code>“ with no Error.</p>
<p>Strangely, if have <a href="https://www.npmjs.com/package/ignore-styles" target="_blank" rel="noopener"><code>ignore-styles</code></a> installed and included a <code>--require ignore-styles</code> flag, and having <code>MiniCssExtractPlugin.loader</code> enabled for <code>test: /\.scss$/</code>, Error will not appear but nor the tests can be carried out. <code>ignore-styles</code> seems not needed but it would result in non-debuggable result when meets <code>MiniCssExtractPlugin.loader</code>.</p>
<p>I have stuck on this problem for quite a long time, as there is no hint on this issue.</p>
<h3 id="Debug-4-No-Error-but-No-Tests-2"><a href="#Debug-4-No-Error-but-No-Tests-2" class="headerlink" title="Debug 4: No Error but No Tests 2"></a>Debug 4: No Error but No Tests 2</h3><p>It only shows: </p>
<pre><code> WEBPACK  Compiled successfully in 2459ms

----------|----------|----------|----------|----------|-------------------|
File      |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |
----------|----------|----------|----------|----------|-------------------|
All files |        0 |        0 |        0 |        0 |                   |
----------|----------|----------|----------|----------|-------------------|
</code></pre><p>The latest stable version of <code>mocha-webpack</code> which only for Webpack 2 and 3. (at the point of writing, its 1.1.0). If you are using Webpack 4, need install the next version (2.0.0+).</p>
<pre><code>npm i mocha-webpack@next --save-dev
</code></pre><p>This is regardless whether you are using <code>@vue/test-utils</code> or <code>vue-test-utils</code>.</p>
<h3 id="Debug-5-TypeError-for-All-Tests"><a href="#Debug-5-TypeError-for-All-Tests" class="headerlink" title="Debug 5: TypeError for All Tests"></a>Debug 5: <code>TypeError</code> for All Tests</h3><p>Tests are properly detected, but all having the following <code>TypeError</code>.</p>
<pre><code>TypeError: Object(...) is not a function
</code></pre><p><strong>Solution:</strong> Please use <code>@vue/test-utils</code> instead of <code>vue-test-utils</code>.</p>
<h3 id="Debug-5-Unexpected-token-import-1"><a href="#Debug-5-Unexpected-token-import-1" class="headerlink" title="Debug 5: Unexpected token import 1"></a>Debug 5: <code>Unexpected token import</code> 1</h3><pre><code>(function (exports, require, module, __filename, __dirname) { import { shallowMount } from &#39;@vue/test-utils&#39;;
                                                              ^^^^^^

SyntaxError: Unexpected token import
</code></pre><p>This may becuase of an additional <code>--require</code> flag in you test script:</p>
<pre><code>&quot;scripts&quot;: {
    &quot;test&quot;: &quot;cross-env NODE_ENV=test nyc mocha-webpack --require test/setup.js --require test/**/*.spec.js&quot;
}
</code></pre><p>The second <code>--require</code> before the <code>test/**/*.spec.js</code> should be removed.</p>
<h3 id="Debug-6-Unexpected-token-import-2"><a href="#Debug-6-Unexpected-token-import-2" class="headerlink" title="Debug 6: Unexpected token import 2"></a>Debug 6: <code>Unexpected token import</code> 2</h3><p>Based on some people’s suggestion, <code>babel</code> may be added to the test script as <code>--require @babel/register</code>:</p>
<pre><code>&quot;scripts&quot;: {
    &quot;test&quot;: &quot;cross-env NODE_ENV=test nyc mocha-webpack --require @babel/register --require test/setup.js test/**/*.spec.js&quot;
}
</code></pre><p>Sometimes there may be warning for <code>import</code> again, which is clearly from <code>@babel</code>.</p>
<pre><code>(function (exports, require, module, __filename, __dirname) { import _Promise from &quot;@babel/runtime-corejs2/core-js/promise&quot;;
                                                                ^^^^^^

SyntaxError: Unexpected token import
</code></pre><p>This would need specify the <code>modules</code> as <code>&quot;commonjs&quot;</code> in <code>babelrc</code> or <code>babel.config.js</code>:</p>
<pre><code>&quot;env&quot;:{
    &quot;test&quot;: {
        &quot;presets&quot;: {
            /* other presets */
            &quot;modules&quot;: &quot;commonjs&quot;
        },
        &quot;plugins&quot;: [&quot;istanbul&quot;, ...]
    }
}
</code></pre><p>Alternatively, <code>@babel/plugin-transform-modules-commonjs</code> plugin can be included:</p>
<pre><code>&quot;env&quot;:{
    &quot;test&quot;: {
        &quot;presets&quot;: {
            /* other presets */
            &quot;modules&quot;: false
        },
        &quot;plugins&quot;: [&quot;istanbul&quot;,&quot;@babel/plugin-transform-modules-commonjs&quot;, ...]
    }
}
</code></pre><p>It should also work if you do both.</p>
<h3 id="Debug-6-Cannot-find-module-or-Unexpected-token-lt"><a href="#Debug-6-Cannot-find-module-or-Unexpected-token-lt" class="headerlink" title="Debug 6: Cannot find module or Unexpected token &lt;"></a>Debug 6: <code>Cannot find module</code> or <code>Unexpected token &lt;</code></h3><pre><code>Error: Cannot find module &#39;@components/myVueComponent.vue&#39;
    at Function.Module._resolveFilename (module.js:536:15)
</code></pre><p><code>&#39;@components&#39;</code> is an alias I set in <code>webpack.config.js</code> pointing to the folder cotaining my Vue component files.</p>
<p>This error may result from the double <code>--require</code> flags (See Debug 5) when <code>@babel/register</code> is also required.</p>
<pre><code>&quot;scripts&quot;: {
    &quot;test&quot;: &quot;cross-env NODE_ENV=test nyc mocha-webpack --require @babel/register --require test/setup.js --require test/**/*.spec.js&quot;
}
</code></pre><p>After seeing above error, one natually would change the path for the Vue components path from <code>@components/myVueComponent.vue&#39;</code> to something like <code>&#39;../my-path-to-components/myVueComponent.vue&#39;</code>. The file you wish to test can be found, but whatever in the <code>webpack.config.js</code> would not take effect such as <code>vue-loader</code>, and would result in the following error:</p>
<pre><code>(function (exports, require, module, __filename, __dirname) { &lt;template&gt;    
                                                              ^

SyntaxError: Unexpected token &lt;
    at createScript (vm.js:80:10)
</code></pre><h3 id="Final"><a href="#Final" class="headerlink" title="Final"></a>Final</h3><p>Eventually, I found out that even I don’t have all these fancy flags, everything still works:</p>
<pre><code>&quot;scripts&quot;: {
    &quot;test&quot;: &quot;cross-env NODE_ENV=test nyc mocha-webpack --require test/setup.js test/**/*.spec.js&quot;,
}
</code></pre><p>As long as:</p>
<ul>
<li><p>I am using <code>mocha-webpack</code> next version (2.0.0) instead of the latest 1.1.0.</p>
</li>
<li><p>I am importing <code>@vue/test-utils</code> instead of <code>vue-test-utils</code>.</p>
</li>
<li><p>Make sure I don’t include <code>MiniCssExtractPlugin.loader</code> for my <code>scss</code> loaders in test environment.</p>
</li>
<li><p>I should not have an additional <code>--require</code> flag before <code>test/**/*.spec.js</code> in the test script.</p>
</li>
<li><p><code>--require @babel/register</code> seems not necessary for my case. However if it is included, make sure the <code>module</code> is specified as <code>&quot;commonjs&quot;</code> in <code>babelrc</code> or <code>babel.config.js</code>, or <code>@babel/plugin-transform-modules-commonjs</code> is included as one of the plugins for test <code>env</code>.</p>
</li>
</ul>

      </div>
    </div>

</div>


                          </div>
                       </div>
                    </div>
                </div>

              </div>

              <!-- Footer -->
              <footer class="blog-footer">
    <p>2017 &copy; Kasei. Template built based on <a href="http://getbootstrap.com">Bootstrap</a>.</p>
</footer>

              <!-- After footer scripts -->
              <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
<script src="/js/ie10-viewport-bug-workaround.js"></script>



            </div>
          </div>

      </div>

  </body>

</html>
